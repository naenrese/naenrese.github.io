
<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>CreateScriptGUI</title>
    </head>
    <body>
        <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
        <script src="blockly/lib/blockly_compressed.js"></script>
        <script src="blockly/lib/blocks_compressed.js"></script>
        <script src="blockly/lib/javascript_compressed.js"></script>
        <script src="blockly/lib/python_compressed.js"></script>
        <script src="blockly/lib/en.js"></script>
        <script src="blocks.js"></script>
        <script src="blockly.js"></script>
        
        
        <!--  ************************ Blocks **************************** -->
        
        
        
        <!--  ************************ Toolbox **************************** -->
        <script type="text/javascript" src="developer/toolbox.js"></script>
        
        <!--  ************** Blockly Workspace definition ***************** -->
        <script src="developer/workspace.js"></script>
        
        <link rel="stylesheet" href="design.css">
        <p>hello!</p>
        <input type="file" accept=".xml" id="file" name="files[]" />
        <output id="list"></output>
        <button type="button" id="button_create">create </button>
        <div class="wrap">
            <interface_code>
                <div class="container">
                    <div class="left-pane">
                        <!-- 左側のコンテンツを配置 -->
                        <h2>main</h2>
                        <button type="button" id="button_create">create </button>
                        <div class="wrap">
                            <div id="blocklyDiv_main" style="height: 500px; width: 70%;"></div>
                            <div class="code_style" id="code_main"></div>
                        </div>
                    </div>
                    <div class="right-pane">
                        <!-- 右側のコンテンツを配置 -->
                        <h2>script</h2>
                        <button type="button" id="button_create">create </button>
                        <div class="wrap">
                            <div id="blocklyDiv_script" style="height: 500px; width: 70%;"></div>
                            <div class="code_style" id="code_script"></div>
                        </div>
                    </div>
                </div>
            </interface_code>
        </div>
        <button type="button" id="button_json">json download</button>
        <button type="button" id="button_xml">xml download</button>
        <!-- <textarea id="story" name="story"
        rows="5" cols="33">
        </textarea> -->

        <script>

    //main interface
    var workspace_main = Blockly.inject('blocklyDiv_main',options)
    function myUpdateFunction_main(event) {
        let code_main = Blockly.JavaScript.workspaceToCode(workspace_main);
        document.getElementById('code_main').innerHTML = '<pre><font size="3" face="Consolas">' + code_main + '</font></pre>';
    }
    workspace_main.addChangeListener(myUpdateFunction_main);

    //script interface
    var workspace_script = Blockly.inject('blocklyDiv_script',options)
    function myUpdateFunction_script(event) {
        let code_script = Blockly.JavaScript.workspaceToCode(workspace_script);
        document.getElementById('code_script').innerHTML = '<pre><font size="3" face="Consolas">' + code_script + '</font></pre>';
    }
    workspace_script.addChangeListener(myUpdateFunction_script);

    // download file
    function download(content, fileName, contentType) {
        var a = document.createElement("a");
        var file = new Blob([content], { type: contentType });
        a.href = URL.createObjectURL(file);
        a.download = fileName;
        a.click();
    }
    function save_json() {
        var code = Blockly.JavaScript.workspaceToCode(workspace);
        var codej = JSON.parse(code);
        download(JSON.stringify(codej),'theaterScript.json','text/plain');
    }
    function save_xml() {
        var xml = Blockly.Xml.workspaceToDom(workspace);
        var myBlockXml = Blockly.Xml.domToText(xml);
        download(myBlockXml,'theaterScriptBlock.xml','text/plain');
    }
    let button_json = document.getElementById('button_json');
    button_json.onclick = save_json;
    let button_xml = document.getElementById('button_xml');
    button_xml.onclick = save_xml;

    // import file
    // ファイルがアップロードされたらデータを取得
    var fileInput = document.getElementById('file');
    var files = null;
    let reader = new FileReader();
    function handleFileSelect(){
        files = fileInput.files;
        for(file of files){
            reader.readAsText(file, 'UTF-8');
        }
    }
    fileInput.addEventListener('change', handleFileSelect);

    function import_xml() {
        if(files != null){
            var xml = Blockly.Xml.textToDom(reader.result);
            Blockly.Xml.clearWorkspaceAndLoadFromXml(xml,workspace);
            console.log(files);
        }
    }
    let button_create = document.getElementById('button_create');
    button_create.onclick = import_xml;

      </script>

</body>
</html>